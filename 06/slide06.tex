\documentclass[14pt]{beamer}
\usepackage{luatexja-fontspec}
\newjfontface{\nonproportional}{BIZ UDMincho}[YokoFeatures={JFM=ujis}]
\setmainjfont[Ligatures={Common,TeX},
  ItalicFont={BIZ UDPMincho},
  ItalicFeatures={FakeSlant=0.27},
  SlantedFont={BIZ UDPMincho},
  SlantedFeatures={FakeSlant=0.18},
  BoldFont={BIZ UDPGothic Bold},
  BoldSlantedFont={BIZ UDPGothic Bold},
  BoldSlantedFeatures={FakeSlant=0.18},
  BoldItalicFont={BIZ UDPGothic Bold},
  BoldItalicFeatures={FakeSlant=0.27},
  YokoFeatures={JFM=prop}]{BIZ UDPMincho}
%\newjfontface{\nonproportional}{BIZ UDGothic}[YokoFeatures={JFM=ujis}]
\setsansjfont[Ligatures={Common,TeX},
  ItalicFont={BIZ UDPGothic},
  ItalicFeatures={FakeSlant=0.23},
  SlantedFont={BIZ UDPGothic},
  SlantedFeatures={FakeSlant=0.23},
  BoldFont={BIZ UDPGothic Bold},
  BoldSlantedFont={BIZ UDPGothic Bold},
  BoldSlantedFeatures={FakeSlant=0.23},
  BoldItalicFont={BIZ UDPGothic Bold},
  BoldItalicFeatures={FakeSlant=0.23},
  YokoFeatures={JFM=prop}]{BIZ UDPGothic}
\usepackage{beamerthemesplit}
\usepackage{caption}
\captionsetup[figure]{labelformat=empty,labelsep=none}
\usepackage{svg}
\usepackage[]{graphicx}
\graphicspath{
  {./images/}
}
\svgsetup{
  inkscapelatex=false
}

\usepackage{listings,jvlisting}
\lstset{
  language=C++,
  basicstyle=\ttfamily\footnotesize,
  % keywordstyle=\bfseries\color{green},
  showstringspaces=false,
  frame={tb},
  %numbers=left,
  xrightmargin=0\zw,
  xleftmargin=0\zw,
  % columns=[l]{fullflexible},
  columns=fixed,
  basewidth=0.5em,
  numberstyle = \footnotesize,
  frame = tbrl,
  captionpos = b,
  moredelim=[is][\color{green}\bfseries]{<\#green\#}{\#>},
  moredelim=[is][\color{blue}\bfseries]{<\#blue\#}{\#>},
  moredelim=[is][\color{red}\bfseries]{<\#red\#}{\#>},
  moredelim=[is][\color{yellow}\bfseries]{<\#yellow\#}{\#>},
  moredelim=[is][\color{magenta}\bfseries]{<\#magenta\#}{\#>},
}

% 余白を広げる
\setbeamersize{text margin left=15pt, text margin right=15pt}
\setbeamertemplate{footline}[frame number]
\title{子どもIT未来塾 第6回}
\author{奥山 祐市}

\begin{document}

\frame{
   \begin{center}
    \huge{子どもIT未来塾}\\

    \vspace{34pt}
	   {\huge 第6回}\\
	   {\huge 音声合成と音声認識}\\
    \vspace{24pt}
    \large{奥山 祐市}
    \vspace{10pt}
    \large{\the\year 年 8月20日}
  \end{center}
}


\begin{frame}
	\frametitle{今日やること}
  \begin{enumerate}
    \item 音声合成
    \begin{enumerate}
      \item 音声合成とは
      \item Open JTalkとは
    \end{enumerate}
    \item 音声認識
    \begin{enumerate}
      \item 音声認識とは
      \item Juliusとは
    \end{enumerate}
  \end{enumerate}
\end{frame}

\begin{frame}
  \frametitle{音声合成}
  \centering
  人間の音声を人工的に作りだすこと
  \begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{chap06/text06-img001.jpg}
    \caption{Pepper (softbank)}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Open JTalk}
  \begin{itemize}
    \item 音声合成のためのソフトウェア
    \item 文字(テキスト)を読み上げる
  \end{itemize}
  \centering
  \includesvg[width=0.8\textwidth]{chap06/text06-img011.svg}
\end{frame}

\begin{frame}
  \frametitle{音声認識}
  \begin{itemize}
    \item 人間の声をコンピュータに認識させること
    \item 話し言葉から文字列への変換
    \item 音声の特徴を捉える
  \end{itemize}
  \begin{figure}[tbp]
  \begin{minipage}[b]{0.45\columnwidth}
    \centering
    \includegraphics[width=\columnwidth]{voice_assistant.png}
    \caption{\scriptsize 携帯、スマートフォン、コンピュータの音声認識アシスタント}
  \end{minipage}
  \hspace{0.04\columnwidth}
  \begin{minipage}[b]{0.3\columnwidth}
    \centering
    \includegraphics[width=\columnwidth]{google_home.png}
    \caption{\scriptsize Google Home}
  \end{minipage}
\end{figure}
  
\end{frame}

\begin{frame}
  \frametitle{Julius}
  \begin{itemize}
    \item 音声認識のためのソフトウェア
    \item 音声を聞き取って文字に変換する
  \end{itemize}
  \centering
  \includesvg[width=0.8\textwidth]{chap06/Julius.svg}
\end{frame}

\begin{frame}
  \frametitle{問題を解こう}
  \begin{itemize}
    \item 教科書3ページ 問題6-1
    \item 教科書3ページ 問題6-2
  \end{itemize}
\end{frame}

\begin{frame}
  \centering
  {\Large 準備}
\end{frame}

\begin{frame}
  \frametitle{ヘッドフォンをつけよう}
  \centering
  \includegraphics[width=0.8\textwidth]{how_to_connect_headset.jpg}
\end{frame}

\begin{frame}
  \frametitle{マイクミュートについて}
  \begin{itemize}
    \item ヘッドセットのコントローラに赤いランプが点いていると「マイクミュート」
    \item マイクを使うときはマイクミュートを解除しておこう
  \end{itemize}
  \centering
  \includegraphics[width=0.8\textwidth]{chap06/text06-img004.png}
\end{frame}

\begin{frame}
  \frametitle{マイク音量の設定}

  \begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{select_sink.png}
    \caption{音声デバイスの選択と設定}
    \includegraphics[width=0.5\textwidth]{microphone_volume.png}
    \caption{マイクの入力音量の調整}
  \end{figure}

\end{frame}

\begin{frame}
  \centering
  {\Large OpenJTalk}
\end{frame}

\begin{frame}[fragile]
  \frametitle{文章を読み上げてもらう(1)}
  
  \begin{lstlisting}[title=openjtalk.hsp,label=openjtalk.hsp]
  #include "hsp3dish.as"
  #include "jtalk.as"

  redraw 0
  mes "発話開始"
  mes "「子どもIT未来塾」"
  redraw 1
  
  <#red#jtload "子どもIT未来塾", 0	;音声ファイルを出力し、読み込む#>
  mmplay 0			<#blue#;音声ファイルを再生する#>
  stop
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{文章を読み上げてもらう(2)}
  \begin{itemize}
    \item プログラムの中の jtload "子どもIT未来塾", 0 の部分を見てみよう
    \item jtload "読ませたい文字列", <バッファ番号>
    \item ""の中の文字列を変えると、好きな言葉を読ませられるよ！
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{声音を変えてみる(1)}
  \begin{lstlisting}[title=voice.hsp,label=voice.hsp]
  #include "hsp3dish.as"
  #include "jtalk.as"

  redraw 0
  mes "発話開始"
  mes "「子どもIT未来塾」"
  redraw 1
 
  <#red#setvoice "htsvoice-tohoku-f01/tohoku-f01-sad.htsvoice" #>
                             <#red#;音声ファイルを指定#>
  jtload "子どもIT未来塾", 0	<#blue#;音声ファイルを出力し、読み込む#>
  mmplay 0			<#blue#;音声ファイルを再生する#>
  stop
  \end{lstlisting}
\end{frame}

\begin{frame}
 \frametitle{声音を変えてみる(2)}
  \begin{itemize}
    \item プログラムの中で音声ファイルを指定している部分を見てみよう
    \item setvoiceの右にある""の中を他のファイルに書き換えると、声音が変わるよ
    \item 他にどんな声音のファイルがあるか教科書を確認してみよう
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{読み上げる文字列に変数を使う(1)}
  \begin{lstlisting}[title=readdate.hsp,label=readdate.hsp]
    #include "hsp3dish.as"
    #include "jtalk.as"

    <#red#date = "" + gettime(0) + "年" + 
                gettime(1) + "月" + gettime(3) + "日"#>

    redraw 0
    mes "日付を読み上げます"
    mes date
    redraw 1

    jtload date, 0 <#blue#;date変数に代入されている文字を
                          音声ファイルにし、読み込む#>
    mmplay 0 ;<#blue#;音声ファイルを再生する#>
    stop
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{読み上げる文字列に変数を使う(2)}
  \begin{itemize}
    \item date = "" + gettime(0) + "年" + gettime(1) + "月" + gettime(3)
    \item gettime 関数で今日の日付を取得する
    \begin{itemize}
       \item 0 = 年、1 = 月、2 = 曜日、3 = 日、4 = 時間、5 = 分、6 = 秒
    \end{itemize}
    \item gettime関数の()の中を変えると、時間や曜日も読ませられるよ!
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{読み上げる文字列に変数を使う(3)}
  \begin{lstlisting}[title=readcalc.hsp,label=readcalc.hsp]
    #include "hsp3dish.as"
    #include "jtalk.as"

    a = 3
    b = 2

   ; 問題描画
    redraw 0
    mes "" + a + " + " + b
    redraw 1

   <#red#; 問題読み上げ
    jtload "" + a + "たす" + b, 0
    mmplay 0
    wait 100#>
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{読み上げる文字列に変数を使う(コード続き)}
  \begin{lstlisting}[title=readcalc.hsp,label=readcalc.hsp]
   ; 答え計算
    kotae = a + b

   <#red#; 答え読み上げ
    jtload "こたえは" + kotae, 1
    mmplay 1#>

   ; 答え描画
    redraw 0
    mes "" + a + " + " + b
    mes "= " + kotae
    redraw 1

    wait 30
    stop
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{問題を解こう}
  \begin{itemize}
    \item 教科書7ページ 問題6-3
    \begin{itemize}
      \item 2問(1問は宿題)
    \end{itemize}

    \item 教科書9ページ 問題6-4
    \begin{itemize}
      \item 2問(1問は宿題)
    \end{itemize}

    \item 教科書11ページ 問題6-5
    \begin{itemize}
      \item 2問(1問は宿題)
    \end{itemize}

    \item 教科書13ページ 問題6-6
    \begin{itemize}
      \item 2問(1問は宿題)
    \end{itemize}
  \end{itemize}
  
\end{frame}

\begin{frame}
  \centering
  {\Large Julius}
\end{frame}

\begin{frame}
  \frametitle{Juliusを使ってみる(1)}
  \begin{itemize}
    \item run-linux-gmm.sh
    \item \<\<please speak\>\>がでるまで待つ
  \end{itemize}
  \centering
  \includegraphics[width=0.8\textwidth]{chap06/text06-img009.png}
\end{frame}

\begin{frame}
  \frametitle{問題を解いてみよう}
  \begin{itemize}
    \item 教科書14ページ 問題6-7
    \begin{itemize}
      \item 1問
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Juliusを使ってみる(2)}
  \begin{itemize}
    \item 果物の名前を話かけてみよう
    \begin{center}
      {\small りんご　みかん　ぶどう　もも　あけび　あんず　いちご　いちじく　かき　スイカ　すもも　	なし　メロン}
    \end{center}
    \item コンピュータは正しく言葉を認識してくれたかな？
    \item 話しかけた単語とターミナルに出てくる単語が同じか友達と話合ってみよう
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{単語辞書}
  \begin{itemize}
    \item すべての言葉をコンピュータに理解してもらうのは大変
    \item そのままのJuliusでは限界がある
    \item コンピュータに理解してほしい言葉をまとめた辞書を作ると改善される！
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{単語辞書を使ってみる}
  \begin{itemize}
    \item 単語辞書を使ってJuliusをためす
    \begin{itemize}
      \item julius.sh kudamono.sh
      \item 以下の単語が登録されているよ。マイクに話しかけてみよう
    \end{itemize}
  \end{itemize}
  \begin{center}
    {\small りんご　みかん　ぶどう　もも　あけび　あんず　いちご　いちじく　かき　スイカ　すもも　	なし　メロン}
  \end{center}
\end{frame}

\begin{frame}
  \frametitle{問題を解いてみよう}
  \begin{itemize}
    \item 教科書15ページ 問題6-8
    \begin{itemize}
      \item 2問
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
\frametitle{結果を見てみよう} 
  \centering
  \includegraphics[width=0.8\textwidth]{julius_demo_strawberry.png} \\
  話かけた単語とターミナルに表示される単語は一致しているかな？
\end{frame}

\begin{frame}
  \frametitle{自分の単語辞書を作ってみよう（１）}
  \begin{itemize}
    \item 認識させたい単語を登録しよう
    \begin{itemize}
      \item kudamono.yomiを参考に…
      \item \<コンピュータが使う名前\> \<読み方\>
      \renewcommand{\theenumi}{\roman{enumi}}
      \begin{enumerate}
        \item りんご
        \item ぶどう
        \item みかん
      \end{enumerate}
    \end{itemize}
    \item \<コンピュータが使う名前\>には日本語も使えるよ
    \begin{itemize}
      \item 林檎 りんご
      \item ブドウ ぶどう
      \item みかん みかん
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{自分の単語辞書を作ってみよう（２）}
  \begin{itemize}
    \item mousepadで自分だけの辞書を作ってみよう
    \begin{itemize}
      \item mousepad jisho.yomi
    \end{itemize}
    \item 例えば…
    \begin{itemize}
      \item 家電辞書
      \item 動物辞書
      \item 植物辞書
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{自分の単語辞書を作ってみよう（３）}
  \begin{itemize}
    \item .yomi : テキストファイル
    \item .dic : コンピュータが読めるファイル
    \begin{itemize}
      \item yomiはコンピュータが読めないので変換する必要がある
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{自分の単語辞書を作ってみよう（４）}
  \begin{itemize}
    \item convert\_yomi.sh コマンド
    \begin{itemize}   
      \item コンピュータ用の辞書へと変換してみよう
      \item convert\_yomi.sh jisyo.yomi  jisyo.dic
    \end{itemize}
    \item julius.sh コマンド
    \begin{itemize}
      \item 自分の作った辞書で音声認識をしてみよう
      \item julius.sh jisyo.dic
    \end{itemize}
    \item コンピュータは上手く言葉を理解してくれるかな？
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{問題を解こう}
  \begin{itemize}
    \item 教科書17ページ 問題6-9
    \begin{itemize}
      \item ５問（１問は宿題）
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{HSPでJuliusの認識結果を使う（１）}
  \begin{figure}
    \includesvg[width=\linewidth]{images/chap06/JuliuswithHSP.svg}
  \end{figure}
\end{frame}

\begin{frame}[fragile]
  \frametitle{HSPでJuliusの認識結果を使う（２）}
  \begin{lstlisting}[caption=julius.hsp,label=julius.hsp]
  #include "hsp3dish.as"
  #include "julius.as"

  redraw 0
  pos 0, 0
  mes "Loading Julius..."
  redraw 1

  init_julius "kudamono.dic" <#blue#;辞書ファイル読み込み#>

  sockidx = 0
  domain = "127.0.0.1"
  PORT = 10500
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{HSPでJuliusの認識結果を使う（３）}
  \begin{lstlisting}[caption=julius.hsp,label=julius.hsp]
  sockopen sockidx, domain, PORT

  if stat != 0 { <#blue#;エラー処理#>
  *errorjulius
    redraw 0
    pos 0, 0
    mes "Error in opening socket"
    redraw 1
    await 30
    goto *errorjulius
    stop
  }

  sdim words, 4096, 0
  ddim cm, 0
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{HSPでJuliusの認識結果を使う（４）}
  \begin{lstlisting}[caption=julius.hsp,label=julius.hsp,basicstyle=\scriptsize]
  repeat -1
    if is_recieved(sockidx) = 0 {
      get_word_list words, cm
      len =  "L1 " + length(words)
      repeat length(words)
        if cm(cnt) > 0.5 { <#blue#;単語信頼度が0.5より大きいとき#>
            ans =  "" + cnt + ": " + words(cnt) + " CM = " + cm(cnt)
        } <#blue#;words(cnt)が認識された文字、cm(cnt)が単語信頼度#>
      loop
    }
    redraw 0
    pos 0,0
    mes len
    mes ans
    redraw 1
    await 30
  loop
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{問題を解こう}
  \begin{itemize}
    \item 教科書20ページ 問題6-10
    \begin{itemize}
      \item 2問
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{音声でLEDのON OFFをする（１）}
  \begin{lstlisting}[caption=ledvoice.hsp,label=ledvoice.hsp]
    #include "hsp3dish.as"
    #include "julius.as"

    redraw 0
    pos 0, 0
    mes "Loading Julius..."
    redraw 1

    init_julius " \textasciitilde /06/onoff.dic" <#blue#;辞書を読み込む#>

    sockidx = 0
    domain = "127.0.0.1"
    PORT = 10500
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{音声でLEDのON OFFをする（２）}
  \begin{lstlisting}[caption=ledvoice.hsp,label=ledvoice.hsp]
    if stat != 0 {
      redraw 0
      mes "Error in opening socket"
      redraw 1
      wait 30
      stop
    }

    sdim wrods, 4096, 0
    ddim cm, 0
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{音声でLEDのON OFFをする（３）}
  \begin{lstlisting}[caption=ledvoice.hsp,label=ledvoice.hsp,basicstyle=\scriptsize]
    repeat -1
    if is_recieved(sockidx) = 0 {
      get_word_list words, cm
      repeat length(words)
        if cm(cnt) > 0.7 {                <#blue#;単語信頼度が0.7より大きいとき#>
          if words(cnt) = "ON" {          <#blue#;認識された文字がONのとき#>
            gpio 17, 1                    <#blue#;GPIO17のLEDを光らせる#>
          }else : if words(cnt) = "OFF" { <#blue#;認識された文字がOFFのとき#>
            gpio 17, 0                    <#blue#;GPIO17のLEDを消す#>
          }
        }
      loop
    }
    redraw 0
    pos 0,0
    mes "話しかけてLEDのONとOFFをしよう"
    redraw 1
    await 30
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{数を認識させてみよう（発展）}
  \begin{itemize}
    \item 数を認識できる
    \begin{itemize}
      \item いち、じゅうさん、せんよんひゃくさんじゅうなな、など
    \end{itemize}
    \item 数を認識させるには「文法」を使う
    \begin{itemize}
      \item 1000（千）まで認識させたかったら1000個以上の単語を登録
      \begin{itemize}
        \item 1(いち)から1000(千)まで登録
        \item 同じ数字でも違う読み(7:なな、しち)
      \end{itemize}
      \item 文法でルールを決める
    \end{itemize}
    \item 参考：
    \begin{itemize}
      \item http://www.atmarkit.co.jp/fxml/ddd/ddd004/ddd004-bnf.html
      \item http://julius.osdn.jp/index.php?q=doc/grammar.html
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{問題を解こう}
  \begin{itemize}
    \item 教科書23ページ 問題6-11
    \begin{itemize}
      \item 5問(2問は宿題)
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{宿題}
  \begin{itemize}
    \item 教科書24ページ
    \begin{itemize}
      \item 5問の内、1問だけ挑戦しよう
      \item レベルアップしたい人は、5問全部に挑戦してみよう
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \centering
  実験
\end{frame}

\begin{frame}
  \frametitle{OpenJTalkやJuliusでできることを考えよう}
  \begin{itemize}
    \item 例えば…
    \begin{itemize}
      \item ボタンを押すと話してくれる
      \item 気温や湿度を教えてくれる
      \item 指示した色のLEDを光らせてくれる
      \item 時刻を聞くと時刻を話してくれる
      \item 日付を聞くと日付を話してくれる
    \end{itemize}
    \item 例を参考に何が作れるかを自分で考えてみよう
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{作りたいものを考えよう}
  \begin{itemize}
    \item OpenJTalkやJuliusを使って作りたいものを考えてみよう(5-10分)
    \item チームのみんなで作りたいものを発表してみよう、一緒に考えてみよう(5-10分)
    \begin{itemize}
      \item むずかしさはどれくらいだろう
      \item どうやって作ればいいだろう
    \end{itemize}
  \end{itemize}
\end{frame}
\begin{frame}
  \frametitle{手順}
  \begin{enumerate}
    \item 演習用のフォルダを作る
    \item 必要なファイルをフォルダにコピーしよう
    \begin{itemize}
      \item hspファイル
      \item yomiファイル
      \item htsvoiceファイル
    \end{itemize}
    \item プログラミングをしてみよう
    \begin{itemize}
      \item hspファイルを書き換えてみる
      \item 新しくhspファイルを作ってみる
    \end{itemize}
  \end{enumerate}
\end{frame}

\begin{frame}
  \frametitle{できたものをチームのみんなに教えよう}
  \begin{itemize}
    \item どんなものを作ったか
    \item 工夫したところはどこか
    \item どうしてその作品を作ったか
  \end{itemize}
  実際に作品を動かしてみんなに見せてみよう！
\end{frame}

\end{document}
